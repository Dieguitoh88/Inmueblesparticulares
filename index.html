<script>
  function prepararYEnviar() {
    const widget = uploadcare.Widget('#uploadcare-input');
    const value = widget.value();

    if (!value) {
      alert("Debes subir al menos una imagen.");
      return;
    }

    // Si es un grupo de archivos
    if (value.startsWith('https://ucarecdn.com/group/')) {
      uploadcare.loadFileGroup(value)
        .then(group => {
          const files = group.files();
          return Promise.all(files.map(f => f.promise()));
        })
        .then(fileInfos => {
          const urls = fileInfos.map(f => f.cdnUrl).join('\n');
          enviarFormulario(urls);
        })
        .catch(() => {
          alert("Error al cargar las imÃ¡genes.");
        });
    } else {
      // Si es un solo archivo
      uploadcare.fileFrom('uploaded', value)
        .then(file => file.promise())
        .then(fileInfo => {
          enviarFormulario(fileInfo.cdnUrl);
        })
        .catch(() => {
          alert("Error al cargar la imagen.");
        });
    }
  }

  function enviarFormulario(urls) {
    document.getElementById('fotos').value = urls;
    document.getElementById('popup').style.display = 'block';

    setTimeout(() => {
      document.getElementById('formulario-publicar').submit();
    }, 2000);
  }

  function cerrarPopup() {
    document.getElementById('popup').style.display = 'none';
  }
</script>
